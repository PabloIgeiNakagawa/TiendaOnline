@using System.Security.Claims
@model TiendaOnline.Domain.Entities.Pedido
@{
    ViewData["Title"] = $"Pedido #{Model.PedidoId.ToString("D6")}";
    var total = Model.DetallesPedido?.Sum(d => d.Cantidad * d.PrecioUnitario) ?? 0;
    var subtotal = total;
    var impuestos = total * 0.19m; // 19% IVA
    var totalConImpuestos = total + impuestos;
    var esAdmin = User.IsInRole("Administrador");
    var esRepartidor = User.IsInRole("Repartidor");
    var esPropioPedido = User.Identity.IsAuthenticated && Model.UsuarioId.ToString() == User.FindFirstValue(ClaimTypes.NameIdentifier);
}

@section Styles{
    <style>
        .timeline::before {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            left: 8px;
            width: 2px;
            background-color: #e9ecef;
        }

        @@keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* Impresión */
        @@media print {
            .btn, .breadcrumb, .timeline::before {
                display: none !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #dee2e6 !important;
            }

            .container-fluid {
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .timeline-icon {
                border: 1px solid #dee2e6 !important;
            }

            .col-lg-8,
            .col-lg-4 {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
            }
        }
    </style>
}

<div class="container-fluid py-4">
    <!-- Breadcrumb y Acciones -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a asp-controller="Home" asp-action="Index" class="text-decoration-none">
                                <i class="bi bi-house-door"></i> Inicio
                            </a>
                        </li>
                        @if (esAdmin)
                        {
                            <li class="breadcrumb-item">
                                <a asp-area="Admin" asp-controller="Pedido" asp-action="Listado" class="text-decoration-none">Gestión de Pedidos</a>
                            </li>
                        }
                        else
                        {
                            <li class="breadcrumb-item">
                                <a asp-area="" asp-controller="Pedido" asp-action="MisPedidos" class="text-decoration-none">Mis Pedidos</a>
                            </li>
                        }
                        <li class="breadcrumb-item active" aria-current="page">
                            Pedido #@Model.PedidoId.ToString("D6")
                        </li>
                    </ol>
                </nav>
                <div class="d-flex gap-2 mt-4 mt-md-0">
                    @if (esAdmin || esRepartidor)
                    {
                        <a asp-controller="Pedido" asp-action="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Volver
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Pedido" asp-action="MisPedidos" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Mis Pedidos
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Pedido -->
        <div class="col-lg-8">
            <!-- Cabecera del Pedido -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            @if (esAdmin)
                            {
                                <text>Información del Pedido</text>
                            }
                            else
                            {
                                <text>Detalles de tu Pedido</text>
                            }
                        </h5>
                        <div class="pedido-badge">
                            @switch (Model.Estado)
                            {
                                case EstadoPedido.Pendiente:
                                    <span class="badge px-3 py-2 rounded-2 fw-semibold text-uppercase bg-warning-subtle text-warning-emphasis border border-warning-subtle ms-1 ms-md-0">
                                        <i class="bi bi-clock me-1"></i>Pendiente
                                    </span>
                                    break;
                                case EstadoPedido.Enviado:
                                    <span class="badge px-3 py-2 rounded-2 fw-semibold text-uppercase bg-info-subtle text-info-emphasis border border-info-subtle ms-1 ms-md-0">
                                        <i class="bi bi-truck me-1"></i>Enviado
                                    </span>
                                    break;
                                case EstadoPedido.Entregado:
                                    <span class="badge px-3 py-2 rounded-2 fw-semibold text-uppercase bg-success-subtle text-success-emphasis border border-success-subtle ms-1 ms-md-0">
                                        <i class="bi bi-check-circle me-1"></i>Entregado
                                    </span>
                                    break;
                                case EstadoPedido.Cancelado:
                                    <span class="badge px-3 py-2 rounded-2 fw-semibold text-uppercase bg-danger-subtle text-danger-emphasis border border-danger-subtle ms-1 ms-md-0">
                                        <i class="bi bi-x-circle me-1"></i>Cancelado
                                    </span>
                                    break;
                            }
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="small text-secondary mb-1">Número de Pedido</div>
                                <div class="fw-medium">#@Model.PedidoId.ToString("D6")</div>
                            </div>
                            <div class="mb-3">
                                <div class="small text-secondary mb-1">Fecha de Pedido</div>
                                <div class="fw-medium">@Model.FechaPedido.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                            <div class="mb-3">
                                <div class="small text-secondary mb-1">
                                    @if (Model.Estado == EstadoPedido.Entregado)
                                    {
                                        <text>Fecha de Entrega</text>
                                    }
                                    else if (Model.Estado == EstadoPedido.Enviado)
                                    {
                                        <text>Fecha Estimada de Entrega</text>
                                    }
                                    else
                                    {
                                        <text>Fecha de Entrega</text>
                                    }
                                </div>
                                <div class="fw-medium">
                                    @if (Model.FechaEntrega.HasValue)
                                    {
                                        @Model.FechaEntrega.Value.ToString("dd/MM/yyyy HH:mm")
                                    }
                                    else if (Model.Estado == EstadoPedido.Enviado)
                                    {
                                        <span class="text-info">@Model.FechaPedido.AddDays(3).ToString("dd/MM/yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Pendiente</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            @if (esAdmin)
                            {
                                <div class="mb-3">
                                    <div class="small text-secondary mb-1">Cliente</div>
                                    <div class="fw-medium">@(Model.Usuario?.Nombre ?? "Cliente no disponible")</div>
                                </div>
                                <div class="mb-3">
                                    <div class="small text-secondary mb-1">Email</div>
                                    <div class="fw-medium">@(Model.Usuario?.Email ?? "Email no disponible")</div>
                                </div>
                                <div class="mb-3">
                                    <div class="small text-secondary mb-1">Teléfono</div>
                                    <div class="fw-medium">@(Model.Usuario?.Telefono ?? "Teléfono no disponible")</div>
                                </div>
                            }
                            else
                            {
                                <div class="mb-3">
                                    <div class="small text-secondary mb-1">Estado del Pedido</div>
                                    <div class="fw-medium">
                                        @switch (Model.Estado)
                                        {
                                            case EstadoPedido.Pendiente:
                                                <span class="text-warning">
                                                    <i class="bi bi-clock me-1"></i>
                                                    Estamos preparando tu pedido
                                                </span>
                                                break;
                                            case EstadoPedido.Enviado:
                                                <span class="text-info">
                                                    <i class="bi bi-truck me-1"></i>
                                                    Tu pedido está en camino
                                                </span>
                                                break;
                                            case EstadoPedido.Entregado:
                                                <span class="text-success">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Pedido entregado exitosamente
                                                </span>
                                                break;
                                            case EstadoPedido.Cancelado:
                                                <span class="text-danger">
                                                    <i class="bi bi-x-circle me-1"></i>
                                                    Pedido cancelado
                                                </span>
                                                break;
                                        }
                                    </div>
                                </div>
                                @if (Model.Estado == EstadoPedido.Enviado)
                                {
                                    <div class="mb-3">
                                        <div class="small text-secondary mb-1">Número de Seguimiento</div>
                                        <div class="fw-medium">
                                            <code>TRK@(Model.PedidoId.ToString("D6"))CO</code>
                                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="copiarSeguimiento()">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                                <div class="mb-3">
                                    <div class="small text-secondary mb-1">Método de Pago</div>
                                    <div class="fw-medium">
                                        <i class="bi bi-credit-card me-1"></i>
                                        Tarjeta de Crédito
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos del Pedido -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="mb-3 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Productos del Pedido</text>
                        }
                        else
                        {
                            <text>Productos Ordenados</text>
                        }
                    </h5>
                </div>
                <!-- Tabla en tamaño MD -->
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle d-none d-md-table">
                            <thead class="table">
                                <tr class="text-secondary">
                                    <th class="p-3 border-bottom">Producto</th>
                                    <th class="p-3 text-center border-bottom">Precio</th>
                                    <th class="p-3 text-center border-bottom">Cantidad</th>
                                    <th class="p-3 text-end border-bottom">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody class="border-top-0">
                                @foreach (var detalle in Model.DetallesPedido)
                                {
                                    <tr>
                                        <td class="py-3">
                                            <div class="d-flex align-items-center">
                                                <img src="@detalle.Producto.ImagenUrl" class="rounded border shadow-sm me-3"
                                                     style="width: 50px; height: 50px; object-fit: cover;">
                                                <span class="fw-semibold text-body">@detalle.Producto.Nombre</span>
                                            </div>
                                        </td>
                                        <td class="p-3 text-center text-body-secondary">$@detalle.PrecioUnitario</td>
                                        <td class="p-3 text-center">
                                            <span class="badge bg-body-secondary text-body border">@detalle.Cantidad</span>
                                        </td>
                                        <td class="p-3 text-end fw-bold text-body">$@(detalle.Cantidad * detalle.PrecioUnitario)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <!-- Cards en menor tamaño que MD -->
                        <div class="d-md-none">
                            @foreach (var detalle in Model.DetallesPedido)
                            {
                                <div class="card mb-3 shadow-sm border-secondary-subtle bg-body">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="@detalle.Producto.ImagenUrl" class="rounded border me-3"
                                                 style="width: 65px; height: 65px; object-fit: cover;">
                                            <div class="overflow-hidden">
                                                <h6 class="mb-1 fw-bold text-body text-truncate">@detalle.Producto.Nombre</h6>
                                                <small class="text-body-secondary">Unitario: $@detalle.PrecioUnitario</small>
                                            </div>
                                        </div>

                                        <div class="row g-0 border-top pt-2 mt-2">
                                            <div class="col-6">
                                                <span class="d-block text-body-secondary small text-uppercase fw-semibold">Cantidad</span>
                                                <span class="text-body fw-bold">@detalle.Cantidad</span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <span class="d-block text-body-secondary small text-uppercase fw-semibold">Subtotal</span>
                                                <span class="fw-bold fs-5">$@(detalle.Cantidad * detalle.PrecioUnitario)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Cambios -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="mb-0 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Historial de Cambios</text>
                        }
                        else
                        {
                            <text>Seguimiento del Pedido</text>
                        }
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="timeline position-relative ps-4">
                        <div class="position-relative pb-4">
                            <div class="position-absolute d-flex align-items-center justify-content-center rounded-circle shadow-sm bg-body-secondary z-1"
                                 style="left: -2rem; width: 32px; height: 32px;">
                                <i class="bi bi-plus-circle"></i>
                            </div>
                            <div class="ps-2">
                                <h6 class="fw-semibold mb-1">
                                    @if (esAdmin)
                                    {
                                        <text>Pedido creado</text>
                                    }
                                    else
                                    {
                                        <text>Pedido realizado</text>
                                    }
                                </h6>
                                <p class="mb-0 text-muted">@Model.FechaPedido.ToString("dd/MM/yyyy HH:mm")</p>
                                <small class="text-muted">
                                    @if (esAdmin)
                                    {
                                        <text>Estado inicial: Pendiente</text>
                                    }
                                    else
                                    {
                                        <text>Tu pedido ha sido recibido y está siendo procesado</text>
                                    }
                                </small>
                            </div>
                        </div>

                        @if (Model.Estado == EstadoPedido.Enviado || Model.Estado == EstadoPedido.Entregado)
                        {
                            <div class="position-relative pb-4">
                                <div class="position-absolute d-flex align-items-center justify-content-center rounded-circle shadow-sm bg-info z-1"
                                     style="left: -2rem; width: 32px; height: 32px;">
                                    <i class="bi bi-truck"></i>
                                </div>
                                <div class="ps-2">
                                    <h6 class="fw-semibold mb-1">
                                        @if (esAdmin)
                                        {
                                            <text>Pedido enviado</text>
                                        }
                                        else
                                        {
                                            <text>Pedido en camino</text>
                                        }
                                    </h6>
                                    <p class="mb-0 text-muted">@(Model.Estado == EstadoPedido.Enviado ? Model.FechaEnvio?.ToString("dd/MM/yyyy HH:mm") : Model.FechaEntrega?.ToString("dd/MM/yyyy HH:mm"))</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Pendiente → Enviado</text>
                                        }
                                        else
                                        {
                                            <text>Tu pedido ha salido de nuestro almacén</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }

                        @if (Model.Estado == EstadoPedido.Entregado)
                        {
                            <div class="position-relative pb-4">
                                <div class="position-absolute d-flex align-items-center justify-content-center rounded-circle shadow-sm bg-success z-1"
                                     style="left: -2rem; width: 32px; height: 32px;">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="ps-2">
                                    <h6 class="fw-semibold mb-1">
                                        @if (esAdmin)
                                        {
                                            <text>Pedido entregado</text>
                                        }
                                        else
                                        {
                                            <text>¡Pedido entregado!</text>
                                        }
                                    </h6>
                                    <p class="mb-0 text-muted">@Model.FechaEntrega?.ToString("dd/MM/yyyy HH:mm")</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Enviado → Entregado</text>
                                        }
                                        else
                                        {
                                            <text>Tu pedido ha sido entregado exitosamente</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }

                        @if (Model.Estado == EstadoPedido.Cancelado)
                        {
                            <div class="position-relative pb-4">
                                <div class="position-absolute d-flex align-items-center justify-content-center rounded-circle shadow-sm bg-danger z-1"
                                     style="left: -2rem; width: 32px; height: 32px;">
                                    <i class="bi bi-x-circle"></i>
                                </div>
                                <div class="ps-2">
                                    <h6 class="fw-semibold mb-1">Pedido cancelado</h6>
                                    <p class="mb-0 text-muted">@Model.FechaCancelado?.ToString("dd/MM/yyyy HH:mm")</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Pendiente → Cancelado</text>
                                        }
                                        else
                                        {
                                            <text>El pedido ha sido cancelado</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen y Acciones -->
        <div class="col-lg-4">
            <!-- Resumen del Pedido -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="mb-0 fw-bold">Resumen del Pedido</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>Subtotal</span>
                        <div class="fw-medium">@subtotal.ToString("C0")</div>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>IVA (19%)</span>
                        <div class="fw-medium">@impuestos.ToString("C0")</div>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>Envío</span>
                        <div class="fw-medium">Gratis</div>
                    </div>
                    <div class="d-flex justify-content-between mt-4 pt-3">
                        <span>Total</span>
                        <div class="fw-medium fs-4">@totalConImpuestos.ToString("C0")</div>
                    </div>
                </div>
            </div>

            <!-- Datos de entrega -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="mb-0 fw-bold">Datos de entrega</h5>
                </div>
                <div class="card-body p-4">
                    <address class="mb-0">
                        <i class="bi bi-person"></i> @(Model.Usuario?.Nombre ?? "Cliente")<br>
                        @* <i class="bi bi-geo-alt"></i>  @(Model.Usuario?.Direccion ?? "Dirección no especificada")<br> *@
                        <i class="bi bi-telephone me-1"></i> @(Model.Usuario?.Telefono ?? "No disponible")<br>
                        <i class="bi bi-envelope me-1"></i> @(Model.Usuario?.Email ?? "No disponible")
                    </address>
                </div>
            </div>

            <!-- Acciones del Pedido -->
            <div class="card rounded-3 shadow border-0 mb-4 overflow-hidden">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="mb-0 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Acciones Administrativas</text>
                        }
                        else
                        {
                            <text>Opciones</text>
                        }
                    </h5>
                </div>
                <div class="card-body p-4">
                    @if (esAdmin)
                    {
                        @if (Model.Estado == EstadoPedido.Pendiente)
                        {
                            <button class="btn btn-info btn-lg w-100 mb-3" onclick="enviarPedido(@Model.PedidoId)">
                                <i class="bi bi-truck me-2"></i>Marcar como Enviado
                            </button>
                            <button class="btn btn-danger btn-lg w-100" onclick="cancelarPedido(@Model.PedidoId)">
                                <i class="bi bi-x-circle me-2"></i>Cancelar Pedido
                            </button>
                        }
                        else if (Model.Estado == EstadoPedido.Enviado && (esAdmin || esRepartidor))
                        {
                            <button class="btn btn-success btn-lg w-100" onclick="entregarPedido(@Model.PedidoId)">
                                <i class="bi bi-check-circle me-2"></i>Marcar como Entregado
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Este pedido se encuentra en estado <strong>@Model.Estado.ToString()</strong> y no puede ser modificado.
                            </div>
                        }
                    }
                    else if (esPropioPedido)
                    {
                        @if (Model.Estado == EstadoPedido.Pendiente)
                        {
                            <button class="btn btn-outline-danger btn-lg w-100 mb-3" onclick="cancelarPedido(@Model.PedidoId)">
                                <i class="bi bi-x-circle me-2"></i>Cancelar Pedido
                            </button>
                        }

                        @if (Model.Estado == EstadoPedido.Entregado)
                        {
                            <a asp-controller="Producto" asp-action="Index" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="bi bi-cart-plus me-2"></i>Comprar de Nuevo
                            </a>
                        }

                        <a asp-controller="Soporte" asp-action="Index" class="btn btn-outline-info btn-lg w-100">
                            <i class="bi bi-headset me-2"></i>Contactar Soporte
                        </a>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No tienes permisos para modificar este pedido.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cambio de Estado -->
<partial name="_ModalCambiarEstado" />

<!-- Formularios Ocultos -->
<div class="d-none">
    @if (esAdmin)
    {
        <form id="enviarPedido@(Model.PedidoId)" asp-area="Admin" asp-controller="Pedido" asp-action="Enviar" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
        </form>

        <form id="entregarPedido@(Model.PedidoId)" asp-area="Admin" asp-controller="Pedido" asp-action="Entregar" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
        </form>

        <form id="cancelarPedido@(Model.PedidoId)" asp-controller="Pedido" asp-action="Cancelar" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
        </form>
    }
</div>

@section Scripts{
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Inicializar tooltips
            var listaTooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltips = listaTooltips.map((elementoTooltip) => new bootstrap.Tooltip(elementoTooltip))
        })
        function enviarPedido(pedidoId) {
            const modal = new bootstrap.Modal(document.getElementById("modalCambioEstado"));
            const mensajeCambioEstado = document.getElementById("mensajeCambioEstado");
            const botonDerecho = document.getElementById("botonDerecho");
            const iconoEstado = document.getElementById("iconoEstado");
            mensajeCambioEstado.textContent = `¿Confirmas que el pedido #${pedidoId.toString().padStart(6, "0")} ha sido enviado?`;
            iconoEstado.className = "bi bi-truck text-info display-4";
            botonDerecho.className = "btn btn-info";
            botonDerecho.textContent = "Marcar como Enviado";
            botonDerecho.onclick = () => {
                // Mostrar loading
                botonDerecho.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Procesando...'
                botonDerecho.disabled = true

                // Enviar formulario
                document.getElementById(`enviarPedido${pedidoId}`).submit()
            }

            modal.show()
        }

        function entregarPedido(pedidoId) {
            const modal = new bootstrap.Modal(document.getElementById("modalCambioEstado"));
            const mensajeCambioEstado = document.getElementById("mensajeCambioEstado");
            const botonDerecho = document.getElementById("botonDerecho");
            const iconoEstado = document.getElementById("iconoEstado");
            mensajeCambioEstado.textContent = `¿Confirmas que el pedido #${pedidoId.toString().padStart(6, "0")} ha sido entregado?`;
            iconoEstado.className = "bi bi-check-circle text-success display-4";
            botonDerecho.className = "btn btn-success";
            botonDerecho.textContent = "Marcar como Entregado";
            botonDerecho.onclick = () => {
                // Mostrar loading
                botonDerecho.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Procesando...'
                botonDerecho.disabled = true

                // Enviar formulario
                document.getElementById(`entregarPedido${pedidoId}`).submit()
            }

            modal.show()
        }

        function cancelarPedido(pedidoId) {
            const modal = new bootstrap.Modal(document.getElementById("modalCambioEstado"));
            const mensajeCambioEstado = document.getElementById("mensajeCambioEstado");
            const botonDerecho = document.getElementById("botonDerecho");
            const iconoEstado = document.getElementById("iconoEstado");
            mensajeCambioEstado.textContent = `¿Estás seguro de cancelar el pedido #${pedidoId.toString().padStart(6, "0")}?`;
            iconoEstado.className = "bi bi-x-circle text-danger display-4";
            botonDerecho.className = "btn btn-danger";
            botonDerecho.textContent = "Cancelar Pedido";
            botonDerecho.onclick = () => {
                // Mostrar loading
                botonDerecho.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Procesando...'
                botonDerecho.disabled = true

                // Enviar formulario
                document.getElementById(`cancelarPedido${pedidoId}`).submit()
            }

            modal.show()
        }

        // Copiar número de seguimiento
        function copiarSeguimiento() {
            const numeroSeguimiento = document.querySelector("code").textContent
            navigator.clipboard
                .writeText(numeroSeguimiento)
                .then(() => {
                    // Mostrar feedback visual
                    const boton = document.querySelector('[onclick="copiarSeguimiento()"]')
                    const iconoOriginal = boton.innerHTML
                    boton.innerHTML = '<i class="bi bi-check"></i>'
                    boton.classList.add("btn-success")
                    boton.classList.remove("btn-outline-primary")

                    setTimeout(() => {
                        boton.innerHTML = iconoOriginal
                        boton.classList.remove("btn-success")
                        boton.classList.add("btn-outline-primary")
                    }, 2000)
                })
                .catch(() => {
                    alert("No se pudo copiar el número de seguimiento")
                })
        }

    </script>
}

