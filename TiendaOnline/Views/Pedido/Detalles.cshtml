@model TiendaOnline.Models.Pedido
@{
    ViewData["Title"] = $"Pedido #{Model.PedidoId.ToString("D6")}";
    var total = Model.DetallesPedido?.Sum(d => d.Cantidad * d.PrecioUnitario) ?? 0;
    var subtotal = total;
    var impuestos = total * 0.19m; // 19% IVA
    var totalConImpuestos = total + impuestos;
    var esAdmin = User.IsInRole("Administrador");
    var esRepartidor = User.IsInRole("Repartidor");
    var esPropioPedido = User.Identity.IsAuthenticated && Model.UsuarioId.ToString() == User.Claims.FirstOrDefault(c => c.Type == "UsuarioId")?.Value;
}

<link rel="stylesheet" href="~/css/Pedido/Detalles.css" asp-append-version="true" />

<div class="container-fluid py-4">
    <!-- Breadcrumb y Acciones -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("Index", "Home")" class="text-decoration-none">
                                <i class="bi bi-house-door"></i> Inicio
                            </a>
                        </li>
                        @if (esAdmin)
                        {
                            <li class="breadcrumb-item">
                                <a href="@Url.Action("Index", "Pedido")" class="text-decoration-none">Gestión de Pedidos</a>
                            </li>
                        }
                        else
                        {
                            <li class="breadcrumb-item">
                                <a href="@Url.Action("MisPedidos", "Pedido")" class="text-decoration-none">Mis Pedidos</a>
                            </li>
                        }
                        <li class="breadcrumb-item active" aria-current="page">
                            Pedido #@Model.PedidoId.ToString("D6")
                        </li>
                    </ol>
                </nav>
                <div class="d-flex gap-2 mt-2 mt-md-0">
                    <button class="btn btn-outline-secondary" onclick="imprimirPedido()">
                        <i class="bi bi-printer me-2"></i>Imprimir
                    </button>
                    @if (esAdmin || esRepartidor)
                    {
                        <button class="btn btn-outline-primary" onclick="exportarPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
                        </button>
                        <a href="@Url.Action("Index", "Pedido")" class="btn btn-outline-dark">
                            <i class="bi bi-arrow-left me-2"></i>Volver
                        </a>
                    }
                    else
                    {
                        <a href="@Url.Action("MisPedidos", "Pedido")" class="btn btn-outline-dark">
                            <i class="bi bi-arrow-left me-2"></i>Mis Pedidos
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Pedido -->
        <div class="col-lg-8">
            <!-- Cabecera del Pedido -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            @if (esAdmin)
                            {
                                <text>Información del Pedido</text>
                            }
                            else
                            {
                                <text>Detalles de tu Pedido</text>
                            }
                        </h5>
                        <div class="pedido-badge">
                            @switch (Model.Estado)
                            {
                                case EstadoPedido.Pendiente:
                                    <span class="badge estado-pendiente">
                                        <i class="bi bi-clock me-1"></i>Pendiente
                                    </span>
                                    break;
                                case EstadoPedido.Enviado:
                                    <span class="badge estado-enviado">
                                        <i class="bi bi-truck me-1"></i>Enviado
                                    </span>
                                    break;
                                case EstadoPedido.Entregado:
                                    <span class="badge estado-entregado">
                                        <i class="bi bi-check-circle me-1"></i>Entregado
                                    </span>
                                    break;
                                case EstadoPedido.Cancelado:
                                    <span class="badge estado-cancelado">
                                        <i class="bi bi-x-circle me-1"></i>Cancelado
                                    </span>
                                    break;
                            }
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-group">
                                <div class="info-label">Número de Pedido</div>
                                <div class="info-value">#@Model.PedidoId.ToString("D6")</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Fecha de Pedido</div>
                                <div class="info-value">@Model.FechaPedido.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">
                                    @if (Model.Estado == EstadoPedido.Entregado)
                                    {
                                        <text>Fecha de Entrega</text>
                                    }
                                    else if (Model.Estado == EstadoPedido.Enviado)
                                    {
                                        <text>Fecha Estimada de Entrega</text>
                                    }
                                    else
                                    {
                                        <text>Fecha de Entrega</text>
                                    }
                                </div>
                                <div class="info-value">
                                    @if (Model.FechaEntrega.HasValue)
                                    {
                                        @Model.FechaEntrega.Value.ToString("dd/MM/yyyy HH:mm")
                                    }
                                    else if (Model.Estado == EstadoPedido.Enviado)
                                    {
                                        <span class="text-info">@Model.FechaPedido.AddDays(3).ToString("dd/MM/yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Pendiente</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            @if (esAdmin)
                            {
                                <div class="info-group">
                                    <div class="info-label">Cliente</div>
                                    <div class="info-value">@(Model.Usuario?.Nombre ?? "Cliente no disponible")</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">@(Model.Usuario?.Email ?? "Email no disponible")</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Teléfono</div>
                                    <div class="info-value">@(Model.Usuario?.Telefono ?? "Teléfono no disponible")</div>
                                </div>
                            }
                            else
                            {
                                <div class="info-group">
                                    <div class="info-label">Estado del Pedido</div>
                                    <div class="info-value">
                                        @switch (Model.Estado)
                                        {
                                            case EstadoPedido.Pendiente:
                                                <span class="text-warning">
                                                    <i class="bi bi-clock me-1"></i>
                                                    Estamos preparando tu pedido
                                                </span>
                                                break;
                                            case EstadoPedido.Enviado:
                                                <span class="text-info">
                                                    <i class="bi bi-truck me-1"></i>
                                                    Tu pedido está en camino
                                                </span>
                                                break;
                                            case EstadoPedido.Entregado:
                                                <span class="text-success">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Pedido entregado exitosamente
                                                </span>
                                                break;
                                            case EstadoPedido.Cancelado:
                                                <span class="text-danger">
                                                    <i class="bi bi-x-circle me-1"></i>
                                                    Pedido cancelado
                                                </span>
                                                break;
                                        }
                                    </div>
                                </div>
                                @if (Model.Estado == EstadoPedido.Enviado)
                                {
                                    <div class="info-group">
                                        <div class="info-label">Número de Seguimiento</div>
                                        <div class="info-value">
                                            <code>TRK@(Model.PedidoId.ToString("D6"))CO</code>
                                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="copiarSeguimiento()">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                                <div class="info-group">
                                    <div class="info-label">Método de Pago</div>
                                    <div class="info-value">
                                        <i class="bi bi-credit-card me-1"></i>
                                        Tarjeta de Crédito
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos del Pedido -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom-0 pb-3">
                    <h5 class="mb-0 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Productos del Pedido</text>
                        }
                        else
                        {
                            <text>Productos Ordenados</text>
                        }
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 p-3">Producto</th>
                                    <th class="border-0 p-3 text-center">Precio Unitario</th>
                                    <th class="border-0 p-3 text-center">Cantidad</th>
                                    <th class="border-0 p-3 text-center">Subtotal</th>
                                    @if (!esAdmin && esPropioPedido)
                                    {
                                        <th class="border-0 py-3 text-center">Acciones</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DetallesPedido != null && Model.DetallesPedido.Any())
                                {
                                    foreach (var detalle in Model.DetallesPedido)
                                    {
                                        <tr>
                                            <td class="py-3">
                                                <div class="d-flex align-items-center">
                                                    <div class="producto-imagen-mini me-3">
                                                        @if (detalle.Producto?.Imagen != null)
                                                        {
                                                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(detalle.Producto.Imagen)"
                                                                 alt="@detalle.Producto.Nombre" class="img-thumbnail"
                                                                 style="width: 50px; height: 50px; object-fit: cover;" />
                                                        }
                                                        else
                                                        {
                                                            <div class="circulo-avatar">
                                                                <i class="bi bi-box"></i>
                                                            </div>
                                                        }
                                                    </div>
                                                    <div>
                                                        <div class="fw-semibold text-dark">
                                                            @if (esAdmin)
                                                            {
                                                                <a href="@Url.Action("Detalle", "Producto", new { id = detalle.ProductoId })" class="text-decoration-none">
                                                                    @(detalle.Producto?.Nombre ?? "Producto no disponible")
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                @(detalle.Producto?.Nombre ?? "Producto no disponible")
                                                            }
                                                        </div>
                                                        <small class="text-muted">
                                                            @if (esAdmin)
                                                            {
                                                                <text>ID: @detalle.ProductoId</text>
                                                            }
                                                            else
                                                            {
                                                                @(detalle.Producto?.Descripcion ?? "")
                                                            }
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="p-3 text-center">
                                                @detalle.PrecioUnitario
                                            </td>
                                            <td class="p-3 text-center">
                                                <span class="badge bg-light text-dark border px-3 py-2">
                                                    @detalle.Cantidad
                                                </span>
                                            </td>
                                            <td class="p-3 text-center fw-bold">
                                                @((detalle.Cantidad * detalle.PrecioUnitario))
                                            </td>
                                            @if (!esAdmin && esPropioPedido)
                                            {
                                                <td class="py-3 text-center">
                                                    <a href="@Url.Action("Detalle", "Producto", new { id = detalle.ProductoId })"
                                                       class="btn btn-sm btn-outline-primary" title="Ver producto">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="@(esAdmin || !esPropioPedido ? "4" : "5")" class="text-center py-4 text-muted">
                                            <i class="bi bi-inbox display-6 mb-3 d-block"></i>
                                            No hay productos en este pedido
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Historial de Cambios -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pb-3">
                    <h5 class="mb-0 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Historial de Cambios</text>
                        }
                        else
                        {
                            <text>Seguimiento del Pedido</text>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-icon bg-primary">
                                <i class="bi bi-plus-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">
                                    @if (esAdmin)
                                    {
                                        <text>Pedido creado</text>
                                    }
                                    else
                                    {
                                        <text>Pedido realizado</text>
                                    }
                                </h6>
                                <p class="mb-0 text-muted">@Model.FechaPedido.ToString("dd/MM/yyyy HH:mm")</p>
                                <small class="text-muted">
                                    @if (esAdmin)
                                    {
                                        <text>Estado inicial: Pendiente</text>
                                    }
                                    else
                                    {
                                        <text>Tu pedido ha sido recibido y está siendo procesado</text>
                                    }
                                </small>
                            </div>
                        </div>

                        @if (Model.Estado == EstadoPedido.Enviado || Model.Estado == EstadoPedido.Entregado)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon bg-info">
                                    <i class="bi bi-truck"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">
                                        @if (esAdmin)
                                        {
                                            <text>Pedido enviado</text>
                                        }
                                        else
                                        {
                                            <text>Pedido en camino</text>
                                        }
                                    </h6>
                                    <p class="mb-0 text-muted">@DateTime.Now.AddDays(-2).ToString("dd/MM/yyyy HH:mm")</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Pendiente → Enviado</text>
                                        }
                                        else
                                        {
                                            <text>Tu pedido ha salido de nuestro almacén</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }

                        @if (Model.Estado == EstadoPedido.Entregado)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon bg-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">
                                        @if (esAdmin)
                                        {
                                            <text>Pedido entregado</text>
                                        }
                                        else
                                        {
                                            <text>¡Pedido entregado!</text>
                                        }
                                    </h6>
                                    <p class="mb-0 text-muted">@Model.FechaEntrega?.ToString("dd/MM/yyyy HH:mm")</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Enviado → Entregado</text>
                                        }
                                        else
                                        {
                                            <text>Tu pedido ha sido entregado exitosamente</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }

                        @if (Model.Estado == EstadoPedido.Cancelado)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon bg-danger">
                                    <i class="bi bi-x-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Pedido cancelado</h6>
                                    <p class="mb-0 text-muted">@DateTime.Now.AddDays(-1).ToString("dd/MM/yyyy HH:mm")</p>
                                    <small class="text-muted">
                                        @if (esAdmin)
                                        {
                                            <text>Cambio de estado: Pendiente → Cancelado</text>
                                        }
                                        else
                                        {
                                            <text>El pedido ha sido cancelado</text>
                                        }
                                    </small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen y Acciones -->
        <div class="col-lg-4">
            <!-- Resumen del Pedido -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="mb-0 fw-bold">Resumen del Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="resumen-item">
                        <div class="resumen-label">Subtotal</div>
                        <div class="resumen-value">@subtotal.ToString("C0")</div>
                    </div>
                    <div class="resumen-item">
                        <div class="resumen-label">IVA (19%)</div>
                        <div class="resumen-value">@impuestos.ToString("C0")</div>
                    </div>
                    <div class="resumen-item">
                        <div class="resumen-label">Envío</div>
                        <div class="resumen-value">Gratis</div>
                    </div>
                    <div class="resumen-total">
                        <div class="resumen-label">Total</div>
                        <div class="resumen-value">@totalConImpuestos.ToString("C0")</div>
                    </div>
                </div>
            </div>

            <!-- Dirección de Envío -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="mb-0 fw-bold">Dirección de Envío</h5>
                </div>
                <div class="card-body">
                    <address class="mb-0">
                        <strong>@(Model.Usuario?.Nombre ?? "Cliente")</strong><br>
                        @(Model.Usuario?.Direccion ?? "Dirección no especificada")<br>
                        Argentina<br>
                        <i class="bi bi-telephone me-1"></i> @(Model.Usuario?.Telefono ?? "No disponible")<br>
                        <i class="bi bi-envelope me-1"></i> @(Model.Usuario?.Email ?? "No disponible")
                    </address>
                </div>
            </div>

            <!-- Acciones del Pedido -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <h5 class="mb-0 fw-bold">
                        @if (esAdmin)
                        {
                            <text>Acciones Administrativas</text>
                        }
                        else
                        {
                            <text>Opciones</text>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (esAdmin)
                    {
                        @if (Model.Estado == EstadoPedido.Pendiente)
                        {
                            <button class="btn btn-info btn-lg w-100 mb-3" onclick="cambiarEstado(@Model.PedidoId, 1, 'Enviado')">
                                <i class="bi bi-truck me-2"></i>Marcar como Enviado
                            </button>
                            <button class="btn btn-danger btn-lg w-100" onclick="cambiarEstado(@Model.PedidoId, 3, 'Cancelado')">
                                <i class="bi bi-x-circle me-2"></i>Cancelar Pedido
                            </button>
                        }
                        else if (Model.Estado == EstadoPedido.Enviado && (esAdmin || esRepartidor))
                        {
                            <button class="btn btn-success btn-lg w-100" onclick="cambiarEstado(@Model.PedidoId, 2, 'Entregado')">
                                <i class="bi bi-check-circle me-2"></i>Marcar como Entregado
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Este pedido se encuentra en estado <strong>@Model.Estado.ToString()</strong> y no puede ser modificado.
                            </div>
                        }
                    }
                    else if (esPropioPedido)
                    {
                        @if (Model.Estado == EstadoPedido.Pendiente)
                        {
                            <button class="btn btn-outline-danger btn-lg w-100 mb-3" onclick="cancelarPedidoUsuario(@Model.PedidoId)">
                                <i class="bi bi-x-circle me-2"></i>Cancelar Pedido
                            </button>
                        }

                        @if (Model.Estado == EstadoPedido.Entregado)
                        {
                            <a href="@Url.Action("Index", "Producto")" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="bi bi-cart-plus me-2"></i>Comprar de Nuevo
                            </a>
                        }

                        <a href="@Url.Action("Index", "Soporte")" class="btn btn-outline-info btn-lg w-100">
                            <i class="bi bi-headset me-2"></i>Contactar Soporte
                        </a>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No tienes permisos para modificar este pedido.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cambio de Estado (Admin) -->
@if (esAdmin)
{
    <div class="modal fade" id="modalCambioEstado" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Cambiar Estado del Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="text-center py-3">
                        <div class="mb-3">
                            <i id="iconoEstado" class="display-4"></i>
                        </div>
                        <p id="mensajeCambioEstado" class="mb-0 fs-6"></p>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="botonConfirmarEstado" class="btn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal de Cancelación (Usuario) -->
@if (!esAdmin && esPropioPedido)
{
    <div class="modal fade" id="modalCancelarPedido" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Cancelar Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="text-center py-3">
                        <div class="mb-3">
                            <i class="bi bi-exclamation-triangle text-warning display-4"></i>
                        </div>
                        <p class="mb-0 fs-6">¿Estás seguro de que deseas cancelar tu pedido #@Model.PedidoId.ToString("D6")?</p>
                        <small class="text-muted">Esta acción no se puede deshacer.</small>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener pedido</button>
                    <button type="button" id="botonCancelarPedido" class="btn btn-danger">Sí, cancelar pedido</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Formularios Ocultos -->
<div style="display: none;">
    @if (esAdmin)
    {
        <form id="formularioCambioEstado@(Model.PedidoId)" asp-controller="Pedido" asp-action="CambiarEstado" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
            <input type="hidden" name="nuevoEstado" value="1" id="nuevoEstado@(Model.PedidoId)" />
        </form>
    }

    @if (!esAdmin && esPropioPedido)
    {
        <form id="formularioCancelarPedido@(Model.PedidoId)" asp-controller="Pedido" asp-action="CancelarPedidoUsuario" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
        </form>
    }
</div>

<script src="~/js/Pedido/Detalles.js" asp-append-version="true"></script>
